import { DEFAULT_PIVOT_KEYS, PivotDimensionType } from '../grids/pivot-grid/pivot-grid.interface';
import { PivotUtil } from '../grids/pivot-grid/pivot-util';
import { FilteringStrategy } from './filtering-strategy';
import { cloneArray } from '../core/utils';
/* csSuppress */
export class NoopPivotDimensionsStrategy {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new NoopPivotDimensionsStrategy());
    }
    process(collection, _, __) {
        return collection;
    }
}
export class PivotRowDimensionsStrategy {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new PivotRowDimensionsStrategy());
    }
    process(collection, rows, values, cloneStrategy, pivotKeys = DEFAULT_PIVOT_KEYS) {
        let hierarchies;
        let data;
        const prevRowDims = [];
        const currRows = cloneArray(rows, true);
        PivotUtil.assignLevels(currRows);
        if (currRows.length === 0) {
            hierarchies = PivotUtil.getFieldsHierarchy(collection, [{ memberName: '', enabled: true }], PivotDimensionType.Row, pivotKeys, cloneStrategy);
            // generate flat data from the hierarchies
            data = PivotUtil.processHierarchy(hierarchies, pivotKeys, 0, true);
            return data;
        }
        for (const row of currRows) {
            if (!data) {
                // build hierarchies - groups and subgroups
                hierarchies = PivotUtil.getFieldsHierarchy(collection, [row], PivotDimensionType.Row, pivotKeys, cloneStrategy);
                // generate flat data from the hierarchies
                data = PivotUtil.processHierarchy(hierarchies, pivotKeys, 0, true);
                prevRowDims.push(row);
            }
            else {
                PivotUtil.processGroups(data, row, pivotKeys, cloneStrategy);
            }
        }
        return data;
    }
}
export class PivotColumnDimensionsStrategy {
    static { this._instance = null; }
    static instance() {
        return this._instance || (this._instance = new PivotColumnDimensionsStrategy());
    }
    process(collection, columns, values, cloneStrategy, pivotKeys = DEFAULT_PIVOT_KEYS) {
        const res = this.processHierarchy(collection, columns, values, pivotKeys, cloneStrategy);
        return res;
    }
    processHierarchy(collection, columns, values, pivotKeys, cloneStrategy) {
        const result = [];
        collection.forEach(rec => {
            // apply aggregations based on the created groups and generate column fields based on the hierarchies
            this.groupColumns(rec, columns, values, pivotKeys, cloneStrategy);
            result.push(rec);
        });
        return result;
    }
    groupColumns(rec, columns, values, pivotKeys, cloneStrategy) {
        const children = rec.children;
        if (children && children.size > 0) {
            children.forEach((childRecs) => {
                if (childRecs) {
                    childRecs.forEach(child => {
                        this.groupColumns(child, columns, values, pivotKeys, cloneStrategy);
                    });
                }
            });
        }
        this.applyAggregates(rec, columns, values, pivotKeys, cloneStrategy);
    }
    applyAggregates(rec, columns, values, pivotKeys, cloneStrategy) {
        const leafRecords = this.getLeafs(rec.records, pivotKeys);
        const hierarchy = PivotUtil.getFieldsHierarchy(leafRecords, columns, PivotDimensionType.Column, pivotKeys, cloneStrategy);
        PivotUtil.applyAggregations(rec, hierarchy, values, pivotKeys);
    }
    getLeafs(records, pivotKeys) {
        let leafs = [];
        for (const rec of records) {
            if (rec[pivotKeys.records]) {
                leafs = leafs.concat(this.getLeafs(rec[pivotKeys.records], pivotKeys));
            }
            else {
                leafs.push(rec);
            }
        }
        return leafs;
    }
}
export class DimensionValuesFilteringStrategy extends FilteringStrategy {
    /**
     * Creates a new instance of FormattedValuesFilteringStrategy.
     *
     * @param fields An array of column field names that should be formatted.
     * If omitted the values of all columns which has formatter will be formatted.
     */
    constructor(fields) {
        super();
        this.fields = fields;
    }
    getFieldValue(rec, fieldName, _isDate = false, _isTime = false, grid) {
        const allDimensions = grid.allDimensions;
        const enabledDimensions = allDimensions.filter(x => x && x.enabled);
        const dim = PivotUtil.flatten(enabledDimensions).find(x => x.memberName === fieldName);
        const value = dim.childLevel ? this._getDimensionValueHierarchy(dim, rec).map(x => `[` + x + `]`).join('.') : PivotUtil.extractValueFromDimension(dim, rec);
        return value;
    }
    getFilterItems(column, tree) {
        const grid = column.grid;
        const enabledDimensions = grid.allDimensions.filter(x => x && x.enabled);
        const data = column.grid.gridAPI.filterDataByExpressions(tree);
        const dim = enabledDimensions.find(x => x.memberName === column.field);
        const allValuesHierarchy = PivotUtil.getFieldsHierarchy(data, [dim], PivotDimensionType.Column, grid.pivotKeys, grid.pivotValueCloneStrategy);
        const isNoop = grid.pivotConfiguration.columnStrategy instanceof NoopPivotDimensionsStrategy || grid.pivotConfiguration.rowStrategy instanceof NoopPivotDimensionsStrategy;
        const items = !isNoop ? this._getFilterItems(allValuesHierarchy, grid.pivotKeys) : [{ value: '' }];
        return Promise.resolve(items);
    }
    _getFilterItems(hierarchy, pivotKeys) {
        const items = [];
        hierarchy.forEach((value) => {
            const val = value.value;
            const path = val.split(pivotKeys.columnDimensionSeparator);
            const hierarchicalValue = path.length > 1 ? path.map(x => `[` + x + `]`).join('.') : val;
            const text = path[path.length - 1];
            items.push({
                value: hierarchicalValue,
                label: text,
                children: this._getFilterItems(value.children, pivotKeys)
            });
        });
        return items;
    }
    _getDimensionValueHierarchy(dim, rec) {
        let path = [];
        const value = PivotUtil.extractValueFromDimension(dim, rec);
        path.push(value);
        if (dim.childLevel) {
            const childVals = this._getDimensionValueHierarchy(dim.childLevel, rec);
            path = path.concat(childVals);
        }
        return path;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGl2b3Qtc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZGF0YS1vcGVyYXRpb25zL3Bpdm90LXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxrQkFBa0IsRUFBdUYsa0JBQWtCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUN2TCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDM0QsT0FBTyxFQUFFLGlCQUFpQixFQUFpQixNQUFNLHNCQUFzQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0MsZ0JBQWdCO0FBQ2hCLE1BQU0sT0FBTywyQkFBMkI7YUFDckIsY0FBUyxHQUFnQyxJQUFJLENBQUM7SUFFdEQsTUFBTSxDQUFDLFFBQVE7UUFDbEIsT0FBTyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLDJCQUEyQixFQUFFLENBQUMsQ0FBQztJQUNsRixDQUFDO0lBRU0sT0FBTyxDQUFDLFVBQWlCLEVBQUUsQ0FBb0IsRUFBRSxFQUFpQjtRQUNyRSxPQUFPLFVBQVUsQ0FBQztJQUN0QixDQUFDOztBQUlMLE1BQU0sT0FBTywwQkFBMEI7YUFDcEIsY0FBUyxHQUErQixJQUFJLENBQUM7SUFFckQsTUFBTSxDQUFDLFFBQVE7UUFDbEIsT0FBTyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLDBCQUEwQixFQUFFLENBQUMsQ0FBQztJQUNqRixDQUFDO0lBRU0sT0FBTyxDQUNWLFVBQWUsRUFDZixJQUF1QixFQUN2QixNQUFxQixFQUNyQixhQUFpQyxFQUNqQyxZQUF3QixrQkFBa0I7UUFFMUMsSUFBSSxXQUFXLENBQUM7UUFDaEIsSUFBSSxJQUF3QixDQUFDO1FB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LEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNsQyxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgeyBDb2x1bW5UeXBlLCBQaXZvdEdyaWRUeXBlIH0gZnJvbSAnLi4vZ3JpZHMvY29tbW9uL2dyaWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IERFRkFVTFRfUElWT1RfS0VZUywgSVBpdm90RGltZW5zaW9uLCBJUGl2b3REaW1lbnNpb25TdHJhdGVneSwgSVBpdm90R3JpZFJlY29yZCwgSVBpdm90S2V5cywgSVBpdm90VmFsdWUsIFBpdm90RGltZW5zaW9uVHlwZSB9IGZyb20gJy4uL2dyaWRzL3Bpdm90LWdyaWQvcGl2b3QtZ3JpZC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUGl2b3RVdGlsIH0gZnJvbSAnLi4vZ3JpZHMvcGl2b3QtZ3JpZC9waXZvdC11dGlsJztcbmltcG9ydCB7IEZpbHRlcmluZ1N0cmF0ZWd5LCBJZ3hGaWx0ZXJJdGVtIH0gZnJvbSAnLi9maWx0ZXJpbmctc3RyYXRlZ3knO1xuaW1wb3J0IHsgY2xvbmVBcnJheSB9IGZyb20gJy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgSUZpbHRlcmluZ0V4cHJlc3Npb25zVHJlZSB9IGZyb20gJy4vZmlsdGVyaW5nLWV4cHJlc3Npb25zLXRyZWUnO1xuaW1wb3J0IHsgSURhdGFDbG9uZVN0cmF0ZWd5IH0gZnJvbSAnLi9kYXRhLWNsb25lLXN0cmF0ZWd5JztcblxuLyogY3NTdXBwcmVzcyAqL1xuZXhwb3J0IGNsYXNzIE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSBpbXBsZW1lbnRzIElQaXZvdERpbWVuc2lvblN0cmF0ZWd5IHtcbiAgICBwcml2YXRlIHN0YXRpYyBfaW5zdGFuY2U6IE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSA9IG51bGw7XG5cbiAgICBwdWJsaWMgc3RhdGljIGluc3RhbmNlKCk6IE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZSB8fCAodGhpcy5faW5zdGFuY2UgPSBuZXcgTm9vcFBpdm90RGltZW5zaW9uc1N0cmF0ZWd5KCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBwcm9jZXNzKGNvbGxlY3Rpb246IGFueVtdLCBfOiBJUGl2b3REaW1lbnNpb25bXSwgX186IElQaXZvdFZhbHVlW10pOiBhbnlbXSB7XG4gICAgICAgIHJldHVybiBjb2xsZWN0aW9uO1xuICAgIH1cbn1cblxuXG5leHBvcnQgY2xhc3MgUGl2b3RSb3dEaW1lbnNpb25zU3RyYXRlZ3kgaW1wbGVtZW50cyBJUGl2b3REaW1lbnNpb25TdHJhdGVneSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBQaXZvdFJvd0RpbWVuc2lvbnNTdHJhdGVneSA9IG51bGw7XG5cbiAgICBwdWJsaWMgc3RhdGljIGluc3RhbmNlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW5zdGFuY2UgfHwgKHRoaXMuX2luc3RhbmNlID0gbmV3IFBpdm90Um93RGltZW5zaW9uc1N0cmF0ZWd5KCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBwcm9jZXNzKFxuICAgICAgICBjb2xsZWN0aW9uOiBhbnksXG4gICAgICAgIHJvd3M6IElQaXZvdERpbWVuc2lvbltdLFxuICAgICAgICB2YWx1ZXM6IElQaXZvdFZhbHVlW10sXG4gICAgICAgIGNsb25lU3RyYXRlZ3k6IElEYXRhQ2xvbmVTdHJhdGVneSxcbiAgICAgICAgcGl2b3RLZXlzOiBJUGl2b3RLZXlzID0gREVGQVVMVF9QSVZPVF9LRVlTXG4gICAgKTogSVBpdm90R3JpZFJlY29yZFtdIHtcbiAgICAgICAgbGV0IGhpZXJhcmNoaWVzO1xuICAgICAgICBsZXQgZGF0YTogSVBpdm90R3JpZFJlY29yZFtdO1xuICAgICAgICBjb25zdCBwcmV2Um93RGltcyA9IFtdO1xuICAgICAgICBjb25zdCBjdXJyUm93cyA9IGNsb25lQXJyYXkocm93cywgdHJ1ZSk7XG4gICAgICAgIFBpdm90VXRpbC5hc3NpZ25MZXZlbHMoY3VyclJvd3MpO1xuXG4gICAgICAgIGlmIChjdXJyUm93cy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIGhpZXJhcmNoaWVzID0gUGl2b3RVdGlsLmdldEZpZWxkc0hpZXJhcmNoeShjb2xsZWN0aW9uLCBbeyBtZW1iZXJOYW1lOiAnJywgZW5hYmxlZDogdHJ1ZSB9XSwgUGl2b3REaW1lbnNpb25UeXBlLlJvdywgcGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5KTtcbiAgICAgICAgICAgIC8vIGdlbmVyYXRlIGZsYXQgZGF0YSBmcm9tIHRoZSBoaWVyYXJjaGllc1xuICAgICAgICAgICAgZGF0YSA9IFBpdm90VXRpbC5wcm9jZXNzSGllcmFyY2h5KGhpZXJhcmNoaWVzLCBwaXZvdEtleXMsIDAsIHRydWUpO1xuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIH1cblxuICAgICAgICBmb3IgKGNvbnN0IHJvdyBvZiBjdXJyUm93cykge1xuICAgICAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICAgICAgLy8gYnVpbGQgaGllcmFyY2hpZXMgLSBncm91cHMgYW5kIHN1Ymdyb3Vwc1xuICAgICAgICAgICAgICAgIGhpZXJhcmNoaWVzID0gUGl2b3RVdGlsLmdldEZpZWxkc0hpZXJhcmNoeShjb2xsZWN0aW9uLCBbcm93XSwgUGl2b3REaW1lbnNpb25UeXBlLlJvdywgcGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5KTtcbiAgICAgICAgICAgICAgICAvLyBnZW5lcmF0ZSBmbGF0IGRhdGEgZnJvbSB0aGUgaGllcmFyY2hpZXNcbiAgICAgICAgICAgICAgICBkYXRhID0gUGl2b3RVdGlsLnByb2Nlc3NIaWVyYXJjaHkoaGllcmFyY2hpZXMsIHBpdm90S2V5cywgMCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgcHJldlJvd0RpbXMucHVzaChyb3cpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBQaXZvdFV0aWwucHJvY2Vzc0dyb3VwcyhkYXRhLCByb3csIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGl2b3RDb2x1bW5EaW1lbnNpb25zU3RyYXRlZ3kgaW1wbGVtZW50cyBJUGl2b3REaW1lbnNpb25TdHJhdGVneSB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBQaXZvdFJvd0RpbWVuc2lvbnNTdHJhdGVneSA9IG51bGw7XG5cbiAgICBwdWJsaWMgc3RhdGljIGluc3RhbmNlKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5faW5zdGFuY2UgfHwgKHRoaXMuX2luc3RhbmNlID0gbmV3IFBpdm90Q29sdW1uRGltZW5zaW9uc1N0cmF0ZWd5KCkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBwcm9jZXNzKFxuICAgICAgICBjb2xsZWN0aW9uOiBJUGl2b3RHcmlkUmVjb3JkW10sXG4gICAgICAgIGNvbHVtbnM6IElQaXZvdERpbWVuc2lvbltdLFxuICAgICAgICB2YWx1ZXM6IElQaXZvdFZhbHVlW10sXG4gICAgICAgIGNsb25lU3RyYXRlZ3k6IElEYXRhQ2xvbmVTdHJhdGVneSxcbiAgICAgICAgcGl2b3RLZXlzOiBJUGl2b3RLZXlzID0gREVGQVVMVF9QSVZPVF9LRVlTXG4gICAgKTogYW55W10ge1xuICAgICAgICBjb25zdCByZXMgPSB0aGlzLnByb2Nlc3NIaWVyYXJjaHkoY29sbGVjdGlvbiwgY29sdW1ucywgdmFsdWVzLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICByZXR1cm4gcmVzO1xuICAgIH1cblxuICAgIHByaXZhdGUgcHJvY2Vzc0hpZXJhcmNoeShjb2xsZWN0aW9uOiBJUGl2b3RHcmlkUmVjb3JkW10sIGNvbHVtbnM6IElQaXZvdERpbWVuc2lvbltdLCB2YWx1ZXMsIHBpdm90S2V5cywgY2xvbmVTdHJhdGVneSkge1xuICAgICAgICBjb25zdCByZXN1bHQ6IElQaXZvdEdyaWRSZWNvcmRbXSA9IFtdO1xuICAgICAgICBjb2xsZWN0aW9uLmZvckVhY2gocmVjID0+IHtcbiAgICAgICAgICAgIC8vIGFwcGx5IGFnZ3JlZ2F0aW9ucyBiYXNlZCBvbiB0aGUgY3JlYXRlZCBncm91cHMgYW5kIGdlbmVyYXRlIGNvbHVtbiBmaWVsZHMgYmFzZWQgb24gdGhlIGhpZXJhcmNoaWVzXG4gICAgICAgICAgICB0aGlzLmdyb3VwQ29sdW1ucyhyZWMsIGNvbHVtbnMsIHZhbHVlcywgcGl2b3RLZXlzLCBjbG9uZVN0cmF0ZWd5KTtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKHJlYyk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ3JvdXBDb2x1bW5zKHJlYzogSVBpdm90R3JpZFJlY29yZCwgY29sdW1ucywgdmFsdWVzLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpIHtcbiAgICAgICAgY29uc3QgY2hpbGRyZW4gPSByZWMuY2hpbGRyZW47XG4gICAgICAgIGlmIChjaGlsZHJlbiAmJiBjaGlsZHJlbi5zaXplID4gMCkge1xuICAgICAgICAgICAgY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGRSZWNzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGNoaWxkUmVjcykge1xuICAgICAgICAgICAgICAgICAgICBjaGlsZFJlY3MuZm9yRWFjaChjaGlsZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdyb3VwQ29sdW1ucyhjaGlsZCwgY29sdW1ucywgdmFsdWVzLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYXBwbHlBZ2dyZWdhdGVzKHJlYywgY29sdW1ucywgdmFsdWVzLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXBwbHlBZ2dyZWdhdGVzKHJlYywgY29sdW1ucywgdmFsdWVzLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpIHtcbiAgICAgICAgY29uc3QgbGVhZlJlY29yZHMgPSB0aGlzLmdldExlYWZzKHJlYy5yZWNvcmRzLCBwaXZvdEtleXMpO1xuICAgICAgICBjb25zdCBoaWVyYXJjaHkgPSBQaXZvdFV0aWwuZ2V0RmllbGRzSGllcmFyY2h5KGxlYWZSZWNvcmRzLCBjb2x1bW5zLCBQaXZvdERpbWVuc2lvblR5cGUuQ29sdW1uLCBwaXZvdEtleXMsIGNsb25lU3RyYXRlZ3kpO1xuICAgICAgICBQaXZvdFV0aWwuYXBwbHlBZ2dyZWdhdGlvbnMocmVjLCBoaWVyYXJjaHksIHZhbHVlcywgcGl2b3RLZXlzKVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGVhZnMocmVjb3JkcywgcGl2b3RLZXlzKSB7XG4gICAgICAgIGxldCBsZWFmcyA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IHJlYyBvZiByZWNvcmRzKSB7XG4gICAgICAgICAgICBpZiAocmVjW3Bpdm90S2V5cy5yZWNvcmRzXSkge1xuICAgICAgICAgICAgICAgIGxlYWZzID0gbGVhZnMuY29uY2F0KHRoaXMuZ2V0TGVhZnMocmVjW3Bpdm90S2V5cy5yZWNvcmRzXSwgcGl2b3RLZXlzKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxlYWZzLnB1c2gocmVjKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGVhZnM7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGltZW5zaW9uVmFsdWVzRmlsdGVyaW5nU3RyYXRlZ3kgZXh0ZW5kcyBGaWx0ZXJpbmdTdHJhdGVneSB7XG5cbiAgICAvKipcbiAgICAgKiBDcmVhdGVzIGEgbmV3IGluc3RhbmNlIG9mIEZvcm1hdHRlZFZhbHVlc0ZpbHRlcmluZ1N0cmF0ZWd5LlxuICAgICAqXG4gICAgICogQHBhcmFtIGZpZWxkcyBBbiBhcnJheSBvZiBjb2x1bW4gZmllbGQgbmFtZXMgdGhhdCBzaG91bGQgYmUgZm9ybWF0dGVkLlxuICAgICAqIElmIG9taXR0ZWQgdGhlIHZhbHVlcyBvZiBhbGwgY29sdW1ucyB3aGljaCBoYXMgZm9ybWF0dGVyIHdpbGwgYmUgZm9ybWF0dGVkLlxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZmllbGRzPzogc3RyaW5nW10pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb3ZlcnJpZGUgZ2V0RmllbGRWYWx1ZShyZWM6IGFueSwgZmllbGROYW1lOiBzdHJpbmcsIF9pc0RhdGUgPSBmYWxzZSwgX2lzVGltZSA9IGZhbHNlLFxuICAgICAgICBncmlkPzogUGl2b3RHcmlkVHlwZSk6IGFueSB7XG4gICAgICAgIGNvbnN0IGFsbERpbWVuc2lvbnMgPSBncmlkLmFsbERpbWVuc2lvbnM7XG4gICAgICAgIGNvbnN0IGVuYWJsZWREaW1lbnNpb25zID0gYWxsRGltZW5zaW9ucy5maWx0ZXIoeCA9PiB4ICYmIHguZW5hYmxlZCk7XG4gICAgICAgIGNvbnN0IGRpbSA6SVBpdm90RGltZW5zaW9uID0gUGl2b3RVdGlsLmZsYXR0ZW4oZW5hYmxlZERpbWVuc2lvbnMpLmZpbmQoeCA9PiB4Lm1lbWJlck5hbWUgPT09IGZpZWxkTmFtZSk7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gZGltLmNoaWxkTGV2ZWwgPyB0aGlzLl9nZXREaW1lbnNpb25WYWx1ZUhpZXJhcmNoeShkaW0sIHJlYykubWFwKHggPT4gYFtgICsgeCArYF1gKS5qb2luKCcuJykgOiBQaXZvdFV0aWwuZXh0cmFjdFZhbHVlRnJvbURpbWVuc2lvbihkaW0sIHJlYyk7XG4gICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb3ZlcnJpZGUgZ2V0RmlsdGVySXRlbXMoY29sdW1uOiBDb2x1bW5UeXBlLCB0cmVlOiBJRmlsdGVyaW5nRXhwcmVzc2lvbnNUcmVlKTogUHJvbWlzZTxJZ3hGaWx0ZXJJdGVtW10+IHtcbiAgICAgICAgY29uc3QgZ3JpZCA9IChjb2x1bW4uZ3JpZCBhcyBhbnkpO1xuICAgICAgICBjb25zdCBlbmFibGVkRGltZW5zaW9ucyA9IGdyaWQuYWxsRGltZW5zaW9ucy5maWx0ZXIoeCA9PiB4ICYmIHguZW5hYmxlZCk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBjb2x1bW4uZ3JpZC5ncmlkQVBJLmZpbHRlckRhdGFCeUV4cHJlc3Npb25zKHRyZWUpO1xuICAgICAgICBjb25zdCBkaW0gPSBlbmFibGVkRGltZW5zaW9ucy5maW5kKHggPT4geC5tZW1iZXJOYW1lID09PSBjb2x1bW4uZmllbGQpO1xuICAgICAgICBjb25zdCBhbGxWYWx1ZXNIaWVyYXJjaHkgPSBQaXZvdFV0aWwuZ2V0RmllbGRzSGllcmFyY2h5KFxuICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgIFtkaW1dLFxuICAgICAgICAgICAgUGl2b3REaW1lbnNpb25UeXBlLkNvbHVtbixcbiAgICAgICAgICAgIGdyaWQucGl2b3RLZXlzLFxuICAgICAgICAgICAgZ3JpZC5waXZvdFZhbHVlQ2xvbmVTdHJhdGVneVxuICAgICAgICApO1xuICAgICAgICBjb25zdCBpc05vb3AgPSBncmlkLnBpdm90Q29uZmlndXJhdGlvbi5jb2x1bW5TdHJhdGVneSBpbnN0YW5jZW9mIE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneSB8fCBncmlkLnBpdm90Q29uZmlndXJhdGlvbi5yb3dTdHJhdGVneSBpbnN0YW5jZW9mIE5vb3BQaXZvdERpbWVuc2lvbnNTdHJhdGVneTtcbiAgICAgICAgY29uc3QgaXRlbXM6IElneEZpbHRlckl0ZW1bXSA9ICFpc05vb3AgPyB0aGlzLl9nZXRGaWx0ZXJJdGVtcyhhbGxWYWx1ZXNIaWVyYXJjaHksIGdyaWQucGl2b3RLZXlzKSA6IFt7dmFsdWUgOiAnJ31dO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGl0ZW1zKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9nZXRGaWx0ZXJJdGVtcyhoaWVyYXJjaHk6IE1hcDxzdHJpbmcsIGFueT4sIHBpdm90S2V5czogSVBpdm90S2V5cykgOiBJZ3hGaWx0ZXJJdGVtW10ge1xuICAgICAgICBjb25zdCBpdGVtczogIElneEZpbHRlckl0ZW1bXSA9IFtdO1xuICAgICAgICBoaWVyYXJjaHkuZm9yRWFjaCgodmFsdWUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHZhbHVlLnZhbHVlO1xuICAgICAgICAgICAgY29uc3QgcGF0aCA9IHZhbC5zcGxpdChwaXZvdEtleXMuY29sdW1uRGltZW5zaW9uU2VwYXJhdG9yKTtcbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoaWNhbFZhbHVlID0gcGF0aC5sZW5ndGggPiAxID8gcGF0aC5tYXAoeCA9PiBgW2AgKyB4ICtgXWApLmpvaW4oJy4nKSA6IHZhbDtcbiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBwYXRoW3BhdGgubGVuZ3RoIC0xXTtcbiAgICAgICAgICAgIGl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICAgIHZhbHVlOiBoaWVyYXJjaGljYWxWYWx1ZSxcbiAgICAgICAgICAgICAgICBsYWJlbDogdGV4dCxcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogdGhpcy5fZ2V0RmlsdGVySXRlbXModmFsdWUuY2hpbGRyZW4sIHBpdm90S2V5cylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGl0ZW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgX2dldERpbWVuc2lvblZhbHVlSGllcmFyY2h5KGRpbTogSVBpdm90RGltZW5zaW9uLCByZWM6IGFueSkgOiBzdHJpbmdbXSB7XG4gICAgICAgIGxldCBwYXRoID0gW107XG4gICAgICAgIGNvbnN0IHZhbHVlID0gUGl2b3RVdGlsLmV4dHJhY3RWYWx1ZUZyb21EaW1lbnNpb24oZGltLCByZWMpO1xuICAgICAgICBwYXRoLnB1c2godmFsdWUpO1xuICAgICAgICBpZiAoZGltLmNoaWxkTGV2ZWwpIHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkVmFscyA9IHRoaXMuX2dldERpbWVuc2lvblZhbHVlSGllcmFyY2h5KGRpbS5jaGlsZExldmVsLCByZWMpO1xuICAgICAgICAgICAgcGF0aCA9IHBhdGguY29uY2F0KGNoaWxkVmFscyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBhdGg7XG4gICAgfVxufVxuIl19