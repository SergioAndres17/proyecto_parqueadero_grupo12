import { __decorate, __param } from "tslib";
import { VerticalAlignment, HorizontalAlignment, Util } from '../services/overlay/utilities';
import { BaseFitPositionStrategy } from '../services/overlay/position/base-fit-position-strategy';
import { Optional } from '@angular/core';
import { fadeIn, fadeOut } from 'igniteui-angular/animations';
/** @hidden @internal */
let SelectPositioningStrategy = class SelectPositioningStrategy extends BaseFitPositionStrategy {
    constructor(select, settings, platform) {
        super();
        this.select = select;
        this.platform = platform;
        this._selectDefaultSettings = {
            horizontalDirection: HorizontalAlignment.Right,
            verticalDirection: VerticalAlignment.Bottom,
            horizontalStartPoint: HorizontalAlignment.Left,
            verticalStartPoint: VerticalAlignment.Top,
            openAnimation: fadeIn,
            closeAnimation: fadeOut
        };
        // Global variables required for cases of !initialCall (page scroll/overlay repositionAll)
        this.global_yOffset = 0;
        this.global_xOffset = 0;
        this.global_styles = {};
        this.settings = Object.assign({}, this._selectDefaultSettings, settings);
    }
    /**
     * Position the element based on the PositionStrategy implementing this interface.
     *
     * @param contentElement The HTML element to be positioned
     * @param size Size of the element
     * @param document reference to the Document object
     * @param initialCall should be true if this is the initial call to the method
     * @param target attaching target for the component to show
     * ```typescript
     * settings.positionStrategy.position(content, size, document, true);
     * ```
     */
    position(contentElement, size, document, initialCall, target) {
        const targetElement = target;
        const rects = super.calculateElementRectangles(contentElement, targetElement);
        // selectFit obj, to be used for both cases of initialCall and !initialCall(page scroll/overlay repositionAll)
        const selectFit = {
            verticalOffset: this.global_yOffset,
            horizontalOffset: this.global_xOffset,
            targetRect: rects.targetRect,
            contentElementRect: rects.elementRect,
            styles: this.global_styles,
            scrollContainer: this.select.scrollContainer,
            scrollContainerRect: this.select.scrollContainer.getBoundingClientRect()
        };
        if (initialCall) {
            this.select.scrollContainer.scrollTop = 0;
            // Fill in the required selectFit object properties.
            selectFit.viewPortRect = Util.getViewportRect(document);
            selectFit.itemElement = this.getInteractionItemElement();
            selectFit.itemRect = selectFit.itemElement.getBoundingClientRect();
            // Calculate input and selected item elements style related variables
            selectFit.styles = this.calculateStyles(selectFit, targetElement);
            selectFit.scrollAmount = this.calculateScrollAmount(selectFit);
            // Calculate how much to offset the overlay container.
            this.calculateYoffset(selectFit);
            this.calculateXoffset(selectFit);
            super.updateViewPortFit(selectFit);
            // container does not fit in viewPort and is out on Top or Bottom
            if (selectFit.fitVertical.back < 0 || selectFit.fitVertical.forward < 0) {
                this.fitInViewport(contentElement, selectFit);
            }
            // Calculate scrollTop independently of the dropdown, as we cover all `igsSelect` specific positioning and
            // scrolling to selected item scenarios here.
            this.select.scrollContainer.scrollTop = selectFit.scrollAmount;
        }
        this.setStyles(contentElement, selectFit);
    }
    /**
     * Obtain the selected item if there is such one or otherwise use the first one
     */
    getInteractionItemElement() {
        let itemElement;
        if (this.select.selectedItem) {
            itemElement = this.select.selectedItem.element.nativeElement;
        }
        else {
            itemElement = this.select.getFirstItemElement();
        }
        return itemElement;
    }
    /**
     * Position the items outer container so selected item text is positioned over input text and if header
     * And/OR footer - both header/footer are visible
     *
     * @param selectFit selectFit to use for computation.
     */
    fitInViewport(contentElement, selectFit) {
        const footer = selectFit.scrollContainerRect.bottom - selectFit.contentElementRect.bottom;
        const header = selectFit.scrollContainerRect.top - selectFit.contentElementRect.top;
        const lastItemFitSize = selectFit.targetRect.bottom + selectFit.styles.itemTextToInputTextDiff - footer;
        const firstItemFitSize = selectFit.targetRect.top - selectFit.styles.itemTextToInputTextDiff - header;
        // out of viewPort on Top
        if (selectFit.fitVertical.back < 0) {
            const possibleScrollAmount = selectFit.scrollContainer.scrollHeight -
                selectFit.scrollContainerRect.height - selectFit.scrollAmount;
            if (possibleScrollAmount + selectFit.fitVertical.back > 0 && firstItemFitSize > selectFit.viewPortRect.top) {
                selectFit.scrollAmount -= selectFit.fitVertical.back;
                selectFit.verticalOffset -= selectFit.fitVertical.back;
                this.global_yOffset = selectFit.verticalOffset;
            }
            else {
                selectFit.verticalOffset = 0;
                this.global_yOffset = 0;
            }
            // out of viewPort on Bottom
        }
        else if (selectFit.fitVertical.forward < 0) {
            if (selectFit.scrollAmount + selectFit.fitVertical.forward > 0 && lastItemFitSize < selectFit.viewPortRect.bottom) {
                selectFit.scrollAmount += selectFit.fitVertical.forward;
                selectFit.verticalOffset += selectFit.fitVertical.forward;
                this.global_yOffset = selectFit.verticalOffset;
            }
            else {
                selectFit.verticalOffset = -selectFit.contentElementRect.height + selectFit.targetRect.height;
                this.global_yOffset = selectFit.verticalOffset;
            }
        }
    }
    /**
     * Sets element's style which effectively positions the provided element
     *
     * @param element Element to position
     * @param selectFit selectFit to use for computation.
     * @param initialCall should be true if this is the initial call to the position method calling setStyles
     */
    setStyles(contentElement, selectFit) {
        super.setStyle(contentElement, selectFit.targetRect, selectFit.contentElementRect, selectFit);
        contentElement.style.width = `${selectFit.styles.contentElementNewWidth}px`; // manage container based on paddings?
        this.global_styles.contentElementNewWidth = selectFit.styles.contentElementNewWidth;
    }
    /**
     * Calculate selected item scroll position.
     */
    calculateScrollAmount(selectFit) {
        const itemElementRect = selectFit.itemRect;
        const scrollContainer = selectFit.scrollContainer;
        const scrollContainerRect = selectFit.scrollContainerRect;
        const scrollDelta = scrollContainerRect.top - itemElementRect.top;
        let scrollPosition = scrollContainer.scrollTop - scrollDelta;
        const dropDownHeight = scrollContainer.clientHeight;
        scrollPosition -= dropDownHeight / 2;
        scrollPosition += itemElementRect.height / 2;
        return Math.round(Math.min(Math.max(0, scrollPosition), scrollContainer.scrollHeight - scrollContainerRect.height));
    }
    /**
     * Calculate the necessary input and selected item styles to be used for positioning item text over input text.
     * Calculate & Set default items container width.
     *
     * @param selectFit selectFit to use for computation.
     */
    calculateStyles(selectFit, target) {
        const styles = {};
        const inputElementStyles = window.getComputedStyle(target);
        const itemElementStyles = window.getComputedStyle(selectFit.itemElement);
        const numericInputFontSize = parseFloat(inputElementStyles.fontSize);
        const numericInputPaddingTop = parseFloat(inputElementStyles.paddingTop);
        const numericInputPaddingBottom = parseFloat(inputElementStyles.paddingBottom);
        const numericItemFontSize = parseFloat(itemElementStyles.fontSize);
        const inputTextToInputTop = ((selectFit.targetRect.bottom - numericInputPaddingBottom)
            - (selectFit.targetRect.top + numericInputPaddingTop) - numericInputFontSize) / 2;
        const itemTextToItemTop = (selectFit.itemRect.height - numericItemFontSize) / 2;
        styles.itemTextToInputTextDiff = Math.round(itemTextToItemTop - inputTextToInputTop - numericInputPaddingTop);
        const numericLeftPadding = parseFloat(itemElementStyles.paddingLeft);
        const numericTextIndent = parseFloat(itemElementStyles.textIndent);
        styles.itemTextPadding = numericLeftPadding;
        styles.itemTextIndent = numericTextIndent;
        // 24 is the input's toggle ddl icon width
        styles.contentElementNewWidth = selectFit.targetRect.width + 24 + numericLeftPadding * 2;
        return styles;
    }
    /**
     * Calculate how much to offset the overlay container for Y-axis.
     */
    calculateYoffset(selectFit) {
        selectFit.verticalOffset = -(selectFit.itemRect.top - selectFit.contentElementRect.top +
            selectFit.styles.itemTextToInputTextDiff - selectFit.scrollAmount);
        this.global_yOffset = selectFit.verticalOffset;
    }
    /**
     * Calculate how much to offset the overlay container for X-axis.
     */
    calculateXoffset(selectFit) {
        selectFit.horizontalOffset = selectFit.styles.itemTextIndent - selectFit.styles.itemTextPadding;
        this.global_xOffset = selectFit.horizontalOffset;
    }
};
SelectPositioningStrategy = __decorate([
    __param(2, Optional())
], SelectPositioningStrategy);
export { SelectPositioningStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvaWduaXRldWktYW5ndWxhci9zcmMvbGliL3NlbGVjdC9zZWxlY3QtcG9zaXRpb25pbmctc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxtQkFBbUIsRUFBMEIsSUFBSSxFQUF3QixNQUFNLCtCQUErQixDQUFDO0FBSTNJLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHlEQUF5RCxDQUFDO0FBRWxHLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekMsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUU5RCx3QkFBd0I7QUFDakIsSUFBTSx5QkFBeUIsR0FBL0IsTUFBTSx5QkFBMEIsU0FBUSx1QkFBdUI7SUFlbEUsWUFBbUIsTUFBcUIsRUFBRSxRQUEyQixFQUFjLFFBQWlDO1FBQ2hILEtBQUssRUFBRSxDQUFDO1FBRE8sV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQUFxRCxhQUFRLEdBQVIsUUFBUSxDQUFlO1FBZDVHLDJCQUFzQixHQUFHO1lBQzdCLG1CQUFtQixFQUFFLG1CQUFtQixDQUFDLEtBQUs7WUFDOUMsaUJBQWlCLEVBQUUsaUJBQWlCLENBQUMsTUFBTTtZQUMzQyxvQkFBb0IsRUFBRSxtQkFBbUIsQ0FBQyxJQUFJO1lBQzlDLGtCQUFrQixFQUFFLGlCQUFpQixDQUFDLEdBQUc7WUFDekMsYUFBYSxFQUFFLE1BQU07WUFDckIsY0FBYyxFQUFFLE9BQU87U0FDMUIsQ0FBQztRQUVGLDBGQUEwRjtRQUNsRixtQkFBYyxHQUFHLENBQUMsQ0FBQztRQUNuQixtQkFBYyxHQUFHLENBQUMsQ0FBQztRQUNuQixrQkFBYSxHQUFpQixFQUFFLENBQUM7UUFJckMsSUFBSSxDQUFDLFFBQVEs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LFlBQVksQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQztJQUNuRCxDQUFDO0lBRUQ7O09BRUc7SUFDSyxnQkFBZ0IsQ0FBQyxTQUFvQjtRQUN6QyxTQUFTLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUM7UUFDaEcsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUM7SUFDckQsQ0FBQztDQUNKLENBQUE7QUExTVkseUJBQXlCO0lBZXNDLFdBQUEsUUFBUSxFQUFFLENBQUE7R0FmekUseUJBQXlCLENBME1yQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFZlcnRpY2FsQWxpZ25tZW50LCBIb3Jpem9udGFsQWxpZ25tZW50LCBQb3NpdGlvblNldHRpbmdzLCBTaXplLCBVdGlsLCBDb25uZWN0ZWRGaXQsIFBvaW50ICB9IGZyb20gJy4uL3NlcnZpY2VzL292ZXJsYXkvdXRpbGl0aWVzJztcbmltcG9ydCB7IElQb3NpdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi4vc2VydmljZXMvb3ZlcmxheS9wb3NpdGlvbic7XG5cbmltcG9ydCB7IElneFNlbGVjdEJhc2UgfSBmcm9tICcuL3NlbGVjdC5jb21tb24nO1xuaW1wb3J0IHsgQmFzZUZpdFBvc2l0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi9zZXJ2aWNlcy9vdmVybGF5L3Bvc2l0aW9uL2Jhc2UtZml0LXBvc2l0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IFBsYXRmb3JtVXRpbCB9IGZyb20gJy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZhZGVJbiwgZmFkZU91dCB9IGZyb20gJ2lnbml0ZXVpLWFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5cbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGNsYXNzIFNlbGVjdFBvc2l0aW9uaW5nU3RyYXRlZ3kgZXh0ZW5kcyBCYXNlRml0UG9zaXRpb25TdHJhdGVneSBpbXBsZW1lbnRzIElQb3NpdGlvblN0cmF0ZWd5IHtcbiAgICBwcml2YXRlIF9zZWxlY3REZWZhdWx0U2V0dGluZ3MgPSB7XG4gICAgICAgIGhvcml6b250YWxEaXJlY3Rpb246IEhvcml6b250YWxBbGlnbm1lbnQuUmlnaHQsXG4gICAgICAgIHZlcnRpY2FsRGlyZWN0aW9uOiBWZXJ0aWNhbEFsaWdubWVudC5Cb3R0b20sXG4gICAgICAgIGhvcml6b250YWxTdGFydFBvaW50OiBIb3Jpem9udGFsQWxpZ25tZW50LkxlZnQsXG4gICAgICAgIHZlcnRpY2FsU3RhcnRQb2ludDogVmVydGljYWxBbGlnbm1lbnQuVG9wLFxuICAgICAgICBvcGVuQW5pbWF0aW9uOiBmYWRlSW4sXG4gICAgICAgIGNsb3NlQW5pbWF0aW9uOiBmYWRlT3V0XG4gICAgfTtcblxuICAgIC8vIEdsb2JhbCB2YXJpYWJsZXMgcmVxdWlyZWQgZm9yIGNhc2VzIG9mICFpbml0aWFsQ2FsbCAocGFnZSBzY3JvbGwvb3ZlcmxheSByZXBvc2l0aW9uQWxsKVxuICAgIHByaXZhdGUgZ2xvYmFsX3lPZmZzZXQgPSAwO1xuICAgIHByaXZhdGUgZ2xvYmFsX3hPZmZzZXQgPSAwO1xuICAgIHByaXZhdGUgZ2xvYmFsX3N0eWxlczogU2VsZWN0U3R5bGVzID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc2VsZWN0OiBJZ3hTZWxlY3RCYXNlLCBzZXR0aW5ncz86IFBvc2l0aW9uU2V0dGluZ3MsIEBPcHRpb25hbCgpIHByb3RlY3RlZCBwbGF0Zm9ybT86IFBsYXRmb3JtVXRpbCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fc2VsZWN0RGVmYXVsdFNldHRpbmdzLCBzZXR0aW5ncyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zaXRpb24gdGhlIGVsZW1lbnQgYmFzZWQgb24gdGhlIFBvc2l0aW9uU3RyYXRlZ3kgaW1wbGVtZW50aW5nIHRoaXMgaW50ZXJmYWNlLlxuICAgICAqXG4gICAgICogQHBhcmFtIGNvbnRlbnRFbGVtZW50IFRoZSBIVE1MIGVsZW1lbnQgdG8gYmUgcG9zaXRpb25lZFxuICAgICAqIEBwYXJhbSBzaXplIFNpemUgb2YgdGhlIGVsZW1lbnRcbiAgICAgKiBAcGFyYW0gZG9jdW1lbnQgcmVmZXJlbmNlIHRvIHRoZSBEb2N1bWVudCBvYmplY3RcbiAgICAgKiBAcGFyYW0gaW5pdGlhbENhbGwgc2hvdWxkIGJlIHRydWUgaWYgdGhpcyBpcyB0aGUgaW5pdGlhbCBjYWxsIHRvIHRoZSBtZXRob2RcbiAgICAgKiBAcGFyYW0gdGFyZ2V0IGF0dGFjaGluZyB0YXJnZXQgZm9yIHRoZSBjb21wb25lbnQgdG8gc2hvd1xuICAgICAqIGBgYHR5cGVzY3JpcHRcbiAgICAgKiBzZXR0aW5ncy5wb3NpdGlvblN0cmF0ZWd5LnBvc2l0aW9uKGNvbnRlbnQsIHNpemUsIGRvY3VtZW50LCB0cnVlKTtcbiAgICAgKiBgYGBcbiAgICAgKi9cbiAgICBwdWJsaWMgb3ZlcnJpZGUgcG9zaXRpb24oY29udGVudEVsZW1lbnQ6IEhUTUxFbGVtZW50LFxuICAgICAgICAgICAgICAgICAgICBzaXplOiBTaXplLFxuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudD86IERvY3VtZW50LFxuICAgICAgICAgICAgICAgICAgICBpbml0aWFsQ2FsbD86IGJvb2xlYW4sXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldD86IFBvaW50IHwgSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0RWxlbWVudCA9IHRhcmdldDtcbiAgICAgICAgY29uc3QgcmVjdHMgPSBzdXBlci5jYWxjdWxhdGVFbGVtZW50UmVjdGFuZ2xlcyhjb250ZW50RWxlbWVudCwgdGFyZ2V0RWxlbWVudCk7XG4gICAgICAgIC8vIHNlbGVjdEZpdCBvYmosIHRvIGJlIHVzZWQgZm9yIGJvdGggY2FzZXMgb2YgaW5pdGlhbENhbGwgYW5kICFpbml0aWFsQ2FsbChwYWdlIHNjcm9sbC9vdmVybGF5IHJlcG9zaXRpb25BbGwpXG4gICAgICAgIGNvbnN0IHNlbGVjdEZpdDogU2VsZWN0Rml0ID0ge1xuICAgICAgICAgICAgdmVydGljYWxPZmZzZXQ6IHRoaXMuZ2xvYmFsX3lPZmZzZXQsXG4gICAgICAgICAgICBob3Jpem9udGFsT2Zmc2V0OiB0aGlzLmdsb2JhbF94T2Zmc2V0LFxuICAgICAgICAgICAgdGFyZ2V0UmVjdDogcmVjdHMudGFyZ2V0UmVjdCxcbiAgICAgICAgICAgIGNvbnRlbnRFbGVtZW50UmVjdDogcmVjdHMuZWxlbWVudFJlY3QsXG4gICAgICAgICAgICBzdHlsZXM6IHRoaXMuZ2xvYmFsX3N0eWxlcyxcbiAgICAgICAgICAgIHNjcm9sbENvbnRhaW5lcjogdGhpcy5zZWxlY3Quc2Nyb2xsQ29udGFpbmVyLFxuICAgICAgICAgICAgc2Nyb2xsQ29udGFpbmVyUmVjdDogdGhpcy5zZWxlY3Quc2Nyb2xsQ29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGluaXRpYWxDYWxsKSB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdC5zY3JvbGxDb250YWluZXIuc2Nyb2xsVG9wID0gMDtcbiAgICAgICAgICAgIC8vIEZpbGwgaW4gdGhlIHJlcXVpcmVkIHNlbGVjdEZpdCBvYmplY3QgcHJvcGVydGllcy5cbiAgICAgICAgICAgIHNlbGVjdEZpdC52aWV3UG9ydFJlY3QgPSBVdGlsLmdldFZpZXdwb3J0UmVjdChkb2N1bWVudCk7XG4gICAgICAgICAgICBzZWxlY3RGaXQuaXRlbUVsZW1lbnQgPSB0aGlzLmdldEludGVyYWN0aW9uSXRlbUVsZW1lbnQoKTtcbiAgICAgICAgICAgIHNlbGVjdEZpdC5pdGVtUmVjdCA9IHNlbGVjdEZpdC5pdGVtRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcblxuICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGlucHV0IGFuZCBzZWxlY3RlZCBpdGVtIGVsZW1lbnRzIHN0eWxlIHJlbGF0ZWQgdmFyaWFibGVzXG4gICAgICAgICAgICBzZWxlY3RGaXQuc3R5bGVzID0gdGhpcy5jYWxjdWxhdGVTdHlsZXMoc2VsZWN0Rml0LCB0YXJnZXRFbGVtZW50KTtcblxuICAgICAgICAgICAgc2VsZWN0Rml0LnNjcm9sbEFtb3VudCA9IHRoaXMuY2FsY3VsYXRlU2Nyb2xsQW1vdW50KHNlbGVjdEZpdCk7XG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgaG93IG11Y2ggdG8gb2Zmc2V0IHRoZSBvdmVybGF5IGNvbnRhaW5lci5cbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlWW9mZnNldChzZWxlY3RGaXQpO1xuICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVYb2Zmc2V0KHNlbGVjdEZpdCk7XG5cbiAgICAgICAgICAgIHN1cGVyLnVwZGF0ZVZpZXdQb3J0Rml0KHNlbGVjdEZpdCk7XG4gICAgICAgICAgICAvLyBjb250YWluZXIgZG9lcyBub3QgZml0IGluIHZpZXdQb3J0IGFuZCBpcyBvdXQgb24gVG9wIG9yIEJvdHRvbVxuICAgICAgICAgICAgaWYgKHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrIDwgMCB8fCBzZWxlY3RGaXQuZml0VmVydGljYWwuZm9yd2FyZCA8IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZpdEluVmlld3BvcnQoY29udGVudEVsZW1lbnQsIHNlbGVjdEZpdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBDYWxjdWxhdGUgc2Nyb2xsVG9wIGluZGVwZW5kZW50bHkgb2YgdGhlIGRyb3Bkb3duLCBhcyB3ZSBjb3ZlciBhbGwgYGlnc1NlbGVjdGAgc3BlY2lmaWMgcG9zaXRpb25pbmcgYW5kXG4gICAgICAgICAgICAvLyBzY3JvbGxpbmcgdG8gc2VsZWN0ZWQgaXRlbSBzY2VuYXJpb3MgaGVyZS5cbiAgICAgICAgICAgIHRoaXMuc2VsZWN0LnNjcm9sbENvbnRhaW5lci5zY3JvbGxUb3AgPSBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc2V0U3R5bGVzKGNvbnRlbnRFbGVtZW50LCBzZWxlY3RGaXQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE9idGFpbiB0aGUgc2VsZWN0ZWQgaXRlbSBpZiB0aGVyZSBpcyBzdWNoIG9uZSBvciBvdGhlcndpc2UgdXNlIHRoZSBmaXJzdCBvbmVcbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0SW50ZXJhY3Rpb25JdGVtRWxlbWVudCgpOiBIVE1MRWxlbWVudCB7XG4gICAgICAgIGxldCBpdGVtRWxlbWVudDtcbiAgICAgICAgaWYgKHRoaXMuc2VsZWN0LnNlbGVjdGVkSXRlbSkge1xuICAgICAgICAgICAgaXRlbUVsZW1lbnQgPSB0aGlzLnNlbGVjdC5zZWxlY3RlZEl0ZW0uZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXRlbUVsZW1lbnQgPSB0aGlzLnNlbGVjdC5nZXRGaXJzdEl0ZW1FbGVtZW50KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGl0ZW1FbGVtZW50O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc2l0aW9uIHRoZSBpdGVtcyBvdXRlciBjb250YWluZXIgc28gc2VsZWN0ZWQgaXRlbSB0ZXh0IGlzIHBvc2l0aW9uZWQgb3ZlciBpbnB1dCB0ZXh0IGFuZCBpZiBoZWFkZXJcbiAgICAgKiBBbmQvT1IgZm9vdGVyIC0gYm90aCBoZWFkZXIvZm9vdGVyIGFyZSB2aXNpYmxlXG4gICAgICpcbiAgICAgKiBAcGFyYW0gc2VsZWN0Rml0IHNlbGVjdEZpdCB0byB1c2UgZm9yIGNvbXB1dGF0aW9uLlxuICAgICAqL1xuICAgIHByb3RlY3RlZCBmaXRJblZpZXdwb3J0KGNvbnRlbnRFbGVtZW50OiBIVE1MRWxlbWVudCwgc2VsZWN0Rml0OiBTZWxlY3RGaXQpIHtcbiAgICAgICAgY29uc3QgZm9vdGVyID0gc2VsZWN0Rml0LnNjcm9sbENvbnRhaW5lclJlY3QuYm90dG9tIC0gc2VsZWN0Rml0LmNvbnRlbnRFbGVtZW50UmVjdC5ib3R0b207XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXJSZWN0LnRvcCAtIHNlbGVjdEZpdC5jb250ZW50RWxlbWVudFJlY3QudG9wO1xuICAgICAgICBjb25zdCBsYXN0SXRlbUZpdFNpemUgPSBzZWxlY3RGaXQudGFyZ2V0UmVjdC5ib3R0b20gKyBzZWxlY3RGaXQuc3R5bGVzLml0ZW1UZXh0VG9JbnB1dFRleHREaWZmIC0gZm9vdGVyO1xuICAgICAgICBjb25zdCBmaXJzdEl0ZW1GaXRTaXplID0gc2VsZWN0Rml0LnRhcmdldFJlY3QudG9wIC0gc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiAtIGhlYWRlcjtcbiAgICAgICAgLy8gb3V0IG9mIHZpZXdQb3J0IG9uIFRvcFxuICAgICAgICBpZiAoc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmJhY2sgPCAwKSB7XG4gICAgICAgICAgICBjb25zdCBwb3NzaWJsZVNjcm9sbEFtb3VudCA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXIuc2Nyb2xsSGVpZ2h0IC1cbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQuc2Nyb2xsQ29udGFpbmVyUmVjdC5oZWlnaHQgLSBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50O1xuICAgICAgICAgICAgaWYgKHBvc3NpYmxlU2Nyb2xsQW1vdW50ICsgc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmJhY2sgPiAwICYmIGZpcnN0SXRlbUZpdFNpemUgPiBzZWxlY3RGaXQudmlld1BvcnRSZWN0LnRvcCkge1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC5zY3JvbGxBbW91bnQgLT0gc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmJhY2s7XG4gICAgICAgICAgICAgICAgc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0IC09IHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2xvYmFsX3lPZmZzZXQgPSBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldCA9IDAgO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2xvYmFsX3lPZmZzZXQgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAvLyBvdXQgb2Ygdmlld1BvcnQgb24gQm90dG9tXG4gICAgICAgIH0gZWxzZSBpZiAoc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmZvcndhcmQgPCAwKSB7XG4gICAgICAgICAgICBpZiAoc2VsZWN0Rml0LnNjcm9sbEFtb3VudCArIHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5mb3J3YXJkID4gMCAmJiBsYXN0SXRlbUZpdFNpemUgPCBzZWxlY3RGaXQudmlld1BvcnRSZWN0LmJvdHRvbSkge1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC5zY3JvbGxBbW91bnQgKz0gc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmZvcndhcmQ7XG4gICAgICAgICAgICAgICAgc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0ICs9IHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5mb3J3YXJkO1xuICAgICAgICAgICAgICAgIHRoaXMuZ2xvYmFsX3lPZmZzZXQgPSBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldCA9IC1zZWxlY3RGaXQuY29udGVudEVsZW1lbnRSZWN0LmhlaWdodCArIHNlbGVjdEZpdC50YXJnZXRSZWN0LmhlaWdodDtcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyBlbGVtZW50J3Mgc3R5bGUgd2hpY2ggZWZmZWN0aXZlbHkgcG9zaXRpb25zIHRoZSBwcm92aWRlZCBlbGVtZW50XG4gICAgICpcbiAgICAgKiBAcGFyYW0gZWxlbWVudCBFbGVtZW50IHRvIHBvc2l0aW9uXG4gICAgICogQHBhcmFtIHNlbGVjdEZpdCBzZWxlY3RGaXQgdG8gdXNlIGZvciBjb21wdXRhdGlvbi5cbiAgICAgKiBAcGFyYW0gaW5pdGlhbENhbGwgc2hvdWxkIGJlIHRydWUgaWYgdGhpcyBpcyB0aGUgaW5pdGlhbCBjYWxsIHRvIHRoZSBwb3NpdGlvbiBtZXRob2QgY2FsbGluZyBzZXRTdHlsZXNcbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgc2V0U3R5bGVzKGNvbnRlbnRFbGVtZW50OiBIVE1MRWxlbWVudCwgc2VsZWN0Rml0OiBTZWxlY3RGaXQpIHtcbiAgICAgICAgc3VwZXIuc2V0U3R5bGUoY29udGVudEVsZW1lbnQsIHNlbGVjdEZpdC50YXJnZXRSZWN0LCBzZWxlY3RGaXQuY29udGVudEVsZW1lbnRSZWN0LCBzZWxlY3RGaXQpO1xuICAgICAgICBjb250ZW50RWxlbWVudC5zdHlsZS53aWR0aCA9IGAke3NlbGVjdEZpdC5zdHlsZXMuY29udGVudEVsZW1lbnROZXdXaWR0aH1weGA7IC8vIG1hbmFnZSBjb250YWluZXIgYmFzZWQgb24gcGFkZGluZ3M/XG4gICAgICAgIHRoaXMuZ2xvYmFsX3N0eWxlcy5jb250ZW50RWxlbWVudE5ld1dpZHRoID0gc2VsZWN0Rml0LnN0eWxlcy5jb250ZW50RWxlbWVudE5ld1dpZHRoO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSBzZWxlY3RlZCBpdGVtIHNjcm9sbCBwb3NpdGlvbi5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNhbGN1bGF0ZVNjcm9sbEFtb3VudChzZWxlY3RGaXQ6IFNlbGVjdEZpdCk6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IGl0ZW1FbGVtZW50UmVjdCA9IHNlbGVjdEZpdC5pdGVtUmVjdDtcbiAgICAgICAgY29uc3Qgc2Nyb2xsQ29udGFpbmVyID0gc2VsZWN0Rml0LnNjcm9sbENvbnRhaW5lcjtcbiAgICAgICAgY29uc3Qgc2Nyb2xsQ29udGFpbmVyUmVjdCA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXJSZWN0O1xuICAgICAgICBjb25zdCBzY3JvbGxEZWx0YSA9IHNjcm9sbENvbnRhaW5lclJlY3QudG9wIC0gaXRlbUVsZW1lbnRSZWN0LnRvcDtcbiAgICAgICAgbGV0IHNjcm9sbFBvc2l0aW9uID0gc2Nyb2xsQ29udGFpbmVyLnNjcm9sbFRvcCAtIHNjcm9sbERlbHRhO1xuXG4gICAgICAgIGNvbnN0IGRyb3BEb3duSGVpZ2h0ID0gc2Nyb2xsQ29udGFpbmVyLmNsaWVudEhlaWdodDtcbiAgICAgICAgc2Nyb2xsUG9zaXRpb24gLT0gZHJvcERvd25IZWlnaHQgLyAyO1xuICAgICAgICBzY3JvbGxQb3NpdGlvbiArPSBpdGVtRWxlbWVudFJlY3QuaGVpZ2h0IC8gMjtcblxuICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChNYXRoLm1pbihNYXRoLm1heCgwLCBzY3JvbGxQb3NpdGlvbiksIHNjcm9sbENvbnRhaW5lci5zY3JvbGxIZWlnaHQgLSBzY3JvbGxDb250YWluZXJSZWN0LmhlaWdodCkpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSB0aGUgbmVjZXNzYXJ5IGlucHV0IGFuZCBzZWxlY3RlZCBpdGVtIHN0eWxlcyB0byBiZSB1c2VkIGZvciBwb3NpdGlvbmluZyBpdGVtIHRleHQgb3ZlciBpbnB1dCB0ZXh0LlxuICAgICAqIENhbGN1bGF0ZSAmIFNldCBkZWZhdWx0IGl0ZW1zIGNvbnRhaW5lciB3aWR0aC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSBzZWxlY3RGaXQgc2VsZWN0Rml0IHRvIHVzZSBmb3IgY29tcHV0YXRpb24uXG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVTdHlsZXMoc2VsZWN0Rml0OiBTZWxlY3RGaXQsIHRhcmdldDogUG9pbnQgfCBIVE1MRWxlbWVudCk6IFNlbGVjdFN0eWxlcyAge1xuICAgICAgICBjb25zdCBzdHlsZXM6IFNlbGVjdFN0eWxlcyA9IHt9O1xuICAgICAgICBjb25zdCBpbnB1dEVsZW1lbnRTdHlsZXMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0YXJnZXQgYXMgRWxlbWVudCk7XG4gICAgICAgIGNvbnN0IGl0ZW1FbGVtZW50U3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoc2VsZWN0Rml0Lml0ZW1FbGVtZW50KTtcbiAgICAgICAgY29uc3QgbnVtZXJpY0lucHV0Rm9udFNpemUgPSBwYXJzZUZsb2F0KGlucHV0RWxlbWVudFN0eWxlcy5mb250U2l6ZSk7XG4gICAgICAgIGNvbnN0IG51bWVyaWNJbnB1dFBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KGlucHV0RWxlbWVudFN0eWxlcy5wYWRkaW5nVG9wKTtcbiAgICAgICAgY29uc3QgbnVtZXJpY0lucHV0UGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoaW5wdXRFbGVtZW50U3R5bGVzLnBhZGRpbmdCb3R0b20pO1xuICAgICAgICBjb25zdCBudW1lcmljSXRlbUZvbnRTaXplID0gcGFyc2VGbG9hdChpdGVtRWxlbWVudFN0eWxlcy5mb250U2l6ZSk7XG4gICAgICAgIGNvbnN0IGlucHV0VGV4dFRvSW5wdXRUb3AgPSAoKHNlbGVjdEZpdC50YXJnZXRSZWN0LmJvdHRvbSAtIG51bWVyaWNJbnB1dFBhZGRpbmdCb3R0b20pXG4gICAgICAgICAgICAtIChzZWxlY3RGaXQudGFyZ2V0UmVjdC50b3AgKyBudW1lcmljSW5wdXRQYWRkaW5nVG9wKSAtIG51bWVyaWNJbnB1dEZvbnRTaXplKSAvIDI7XG4gICAgICAgIGNvbnN0IGl0ZW1UZXh0VG9JdGVtVG9wID0gKHNlbGVjdEZpdC5pdGVtUmVjdC5oZWlnaHQgLSBudW1lcmljSXRlbUZvbnRTaXplKSAvIDI7XG4gICAgICAgIHN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiA9IE1hdGgucm91bmQoaXRlbVRleHRUb0l0ZW1Ub3AgLSBpbnB1dFRleHRUb0lucHV0VG9wIC0gbnVtZXJpY0lucHV0UGFkZGluZ1RvcCk7XG5cbiAgICAgICAgY29uc3QgbnVtZXJpY0xlZnRQYWRkaW5nID0gcGFyc2VGbG9hdChpdGVtRWxlbWVudFN0eWxlcy5wYWRkaW5nTGVmdCk7XG4gICAgICAgIGNvbnN0IG51bWVyaWNUZXh0SW5kZW50ID0gcGFyc2VGbG9hdChpdGVtRWxlbWVudFN0eWxlcy50ZXh0SW5kZW50KTtcblxuICAgICAgICBzdHlsZXMuaXRlbVRleHRQYWRkaW5nID0gbnVtZXJpY0xlZnRQYWRkaW5nO1xuICAgICAgICBzdHlsZXMuaXRlbVRleHRJbmRlbnQgPSBudW1lcmljVGV4dEluZGVudDtcbiAgICAgICAgLy8gMjQgaXMgdGhlIGlucHV0J3MgdG9nZ2xlIGRkbCBpY29uIHdpZHRoXG4gICAgICAgIHN0eWxlcy5jb250ZW50RWxlbWVudE5ld1dpZHRoID0gc2VsZWN0Rml0LnRhcmdldFJlY3Qud2lkdGggKyAyNCArIG51bWVyaWNMZWZ0UGFkZGluZyAqIDI7XG5cbiAgICAgICAgcmV0dXJuIHN0eWxlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgaG93IG11Y2ggdG8gb2Zmc2V0IHRoZSBvdmVybGF5IGNvbnRhaW5lciBmb3IgWS1heGlzLlxuICAgICAqL1xuICAgIHByaXZhdGUgY2FsY3VsYXRlWW9mZnNldChzZWxlY3RGaXQ6IFNlbGVjdEZpdCkge1xuICAgICAgICBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQgPSAtKHNlbGVjdEZpdC5pdGVtUmVjdC50b3AgLSBzZWxlY3RGaXQuY29udGVudEVsZW1lbnRSZWN0LnRvcCArXG4gICAgICAgICAgICBzZWxlY3RGaXQuc3R5bGVzLml0ZW1UZXh0VG9JbnB1dFRleHREaWZmIC0gc2VsZWN0Rml0LnNjcm9sbEFtb3VudCk7XG4gICAgICAgIHRoaXMuZ2xvYmFsX3lPZmZzZXQgPSBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsY3VsYXRlIGhvdyBtdWNoIHRvIG9mZnNldCB0aGUgb3ZlcmxheSBjb250YWluZXIgZm9yIFgtYXhpcy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNhbGN1bGF0ZVhvZmZzZXQoc2VsZWN0Rml0OiBTZWxlY3RGaXQpIHtcbiAgICAgICAgc2VsZWN0Rml0Lmhvcml6b250YWxPZmZzZXQgPSBzZWxlY3RGaXQuc3R5bGVzLml0ZW1UZXh0SW5kZW50IC0gc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dFBhZGRpbmc7XG4gICAgICAgIHRoaXMuZ2xvYmFsX3hPZmZzZXQgPSBzZWxlY3RGaXQuaG9yaXpvbnRhbE9mZnNldDtcbiAgICB9XG59XG5cbi8qKiBAaGlkZGVuICovXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdEZpdCBleHRlbmRzIENvbm5lY3RlZEZpdCB7XG4gICAgaXRlbUVsZW1lbnQ/OiBIVE1MRWxlbWVudDtcbiAgICBzY3JvbGxDb250YWluZXI6IEhUTUxFbGVtZW50O1xuICAgIHNjcm9sbENvbnRhaW5lclJlY3Q6IENsaWVudFJlY3Q7XG4gICAgaXRlbVJlY3Q/OiBDbGllbnRSZWN0O1xuICAgIHN0eWxlcz86IFNlbGVjdFN0eWxlcztcbiAgICBzY3JvbGxBbW91bnQ/OiBudW1iZXI7XG59XG5cbi8qKiBAaGlkZGVuICovXG5leHBvcnQgaW50ZXJmYWNlIFNlbGVjdFN0eWxlcyB7XG4gICAgaXRlbVRleHRQYWRkaW5nPzogbnVtYmVyO1xuICAgIGl0ZW1UZXh0SW5kZW50PzogbnVtYmVyO1xuICAgIGl0ZW1UZXh0VG9JbnB1dFRleHREaWZmPzogbnVtYmVyO1xuICAgIGNvbnRlbnRFbGVtZW50TmV3V2lkdGg/OiBudW1iZXI7XG4gICAgbnVtZXJpY0xlZnRQYWRkaW5nPzogbnVtYmVyO1xufVxuIl19