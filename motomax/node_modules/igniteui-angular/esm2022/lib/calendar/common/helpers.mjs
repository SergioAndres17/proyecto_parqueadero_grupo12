import { CalendarDay, daysInWeek, toCalendarDay, } from "./model";
import { DateRangeType } from "./types";
import { first, last, modulo } from "../../core/utils";
export function areSameMonth(firstMonth, secondMonth) {
    const [a, b] = [toCalendarDay(firstMonth), toCalendarDay(secondMonth)];
    return a.year === b.year && a.month === b.month;
}
export function isNextMonth(target, origin) {
    const [a, b] = [toCalendarDay(target), toCalendarDay(origin)];
    return a.year === b.year ? a.month > b.month : a.year > b.year;
}
export function isPreviousMonth(target, origin) {
    const [a, b] = [toCalendarDay(target), toCalendarDay(origin)];
    return a.year === b.year ? a.month < b.month : a.year < b.year;
}
/** Returns the next date starting from `start` that does not match the `disabled` descriptors */
export function getNextActiveDate(start, disabled = []) {
    while (isDateInRanges(start, disabled)) {
        start = start.add("day", 1);
    }
    return start;
}
/** Returns the previous date starting from `start` that does not match the `disabled` descriptors */
export function getPreviousActiveDate(start, disabled = []) {
    while (isDateInRanges(start, disabled)) {
        start = start.add("day", -1);
    }
    return start;
}
export function getClosestActiveDate(start, delta, disabled = []) {
    // TODO: implement a more robust logic for max attempts,
    // i.e. the amount of days to jump between before giving up
    // currently it will try to find the closest date for a year
    const maxAttempts = 366;
    let date = start;
    let attempts = 0;
    while (attempts < maxAttempts) {
        date = start.add("day", delta * (attempts + 1));
        if (!isDateInRanges(date, disabled)) {
            return date;
        }
        attempts++;
    }
    return date;
}
/**
 * Returns a generator yielding day values between `start` and `end` (non-inclusive)
 * by a given `unit` as a step.
 *
 * @remarks
 * By default, `unit` is set to 'day'.
 */
export function* calendarRange(options) {
    let low = toCalendarDay(options.start);
    const unit = options.unit ?? "day";
    const high = typeof options.end === "number"
        ? low.add(unit, options.end)
        : toCalendarDay(options.end);
    const reverse = high.lessThan(low);
    const step = reverse ? -1 : 1;
    while (!reverse ? low.lessThan(high) : low.greaterThan(high)) {
        yield low;
        low = low.add(unit, step);
    }
}
export function* generateMonth(value, firstWeekDay) {
    const { year, month } = toCalendarDay(value);
    const start = new CalendarDay({ year, month });
    const offset = modulo(start.day - firstWeekDay, daysInWeek);
    yield* calendarRange({
        start: start.add("day", -offset),
        end: 42,
    });
}
export function getYearRange(current, range) {
    const year = toCalendarDay(current).year;
    const start = Math.floor(year / range) * range;
    return { start, end: start + range - 1 };
}
export function isDateInRanges(date, ranges) {
    const value = toCalendarDay(date);
    return ranges.some((range) => {
        const days = (range.dateRange ?? []).map((day) => toCalendarDay(day));
        switch (range.type) {
            case DateRangeType.After:
                return value.greaterThan(first(days));
            case DateRangeType.Before:
                return value.lessThan(first(days));
            case DateRangeType.Between: {
                const min = Math.min(first(days).timestamp, last(days).timestamp);
                const max = Math.max(first(days).timestamp, last(days).timestamp);
                return value.timestamp >= min && value.timestamp <= max;
            }
            case DateRangeType.Specific:
                return days.some((day) => day.equalTo(value));
            case DateRangeType.Weekdays:
                return !value.weekend;
            case DateRangeType.Weekends:
                return value.weekend;
            default:
                return false;
        }
    });
}
export function formatToParts(date, locale, options, parts) {
    const formatter = new Intl.DateTimeFormat(locale, options);
    const result = {
        date,
        full: formatter.format(date),
    };
    const getFormattedPart = (formattedParts, partType) => {
        const part = formattedParts.find(({ type }) => type === partType);
        const nextPart = formattedParts[formattedParts.indexOf(part) + 1];
        const value = part?.value || "";
        const literal = nextPart?.type === "literal" ? nextPart.value : "";
        return {
            value,
            literal,
            combined: value + literal,
        };
    };
    if ("formatToParts" in formatter) {
        const formattedParts = formatter.formatToParts(date);
        parts.forEach((part) => (result[part] = getFormattedPart(formattedParts, part)));
    }
    else {
        parts.forEach((part) => (result[part] = { value: "", literal: "", combined: "" }));
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2lnbml0ZXVpLWFuZ3VsYXIvc3JjL2xpYi9jYWxlbmRhci9jb21tb24vaGVscGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsV0FBVyxFQUdYLFVBQVUsRUFDVixhQUFhLEdBQ2hCLE1BQU0sU0FBUyxDQUFDO0FBQ2pCLE9BQU8sRUFBdUIsYUFBYSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBUXZELE1BQU0sVUFBVSxZQUFZLENBQ3hCLFVBQXdCLEVBQ3hCLFdBQXlCO0lBRXpCLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQUUsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFDdkUsT0FBTyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3BELENBQUM7QUFFRCxNQUFNLFVBQVUsV0FBVyxDQUFDLE1BQW9CLEVBQUUsTUFBb0I7SUFDbEUsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUM5RCxPQUFPLENBQUMsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDbkUsQ0FBQztBQUVELE1BQU0sVUFBVSxl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LE9BQU8sQ0FDVCxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQ3BFLENBQUM7SUFDTixDQUFDO1NBQU0sQ0FBQztRQUNKLEtBQUssQ0FBQyxPQUFPLENBQ1QsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUN0RSxDQUFDO0lBQ04sQ0FBQztJQUVELE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENhbGVuZGFyRGF5LFxuICAgIENhbGVuZGFyUmFuZ2VQYXJhbXMsXG4gICAgRGF5UGFyYW1ldGVyLFxuICAgIGRheXNJbldlZWssXG4gICAgdG9DYWxlbmRhckRheSxcbn0gZnJvbSBcIi4vbW9kZWxcIjtcbmltcG9ydCB7IERhdGVSYW5nZURlc2NyaXB0b3IsIERhdGVSYW5nZVR5cGUgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0IHsgZmlyc3QsIGxhc3QsIG1vZHVsbyB9IGZyb20gXCIuLi8uLi9jb3JlL3V0aWxzXCI7XG5cbmludGVyZmFjZSBJRm9ybWF0dGVkUGFydHMge1xuICAgIHZhbHVlOiBzdHJpbmc7XG4gICAgbGl0ZXJhbDogc3RyaW5nO1xuICAgIGNvbWJpbmVkOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhcmVTYW1lTW9udGgoXG4gICAgZmlyc3RNb250aDogRGF5UGFyYW1ldGVyLFxuICAgIHNlY29uZE1vbnRoOiBEYXlQYXJhbWV0ZXIsXG4pIHtcbiAgICBjb25zdCBbYSwgYl0gPSBbdG9DYWxlbmRhckRheShmaXJzdE1vbnRoKSwgdG9DYWxlbmRhckRheShzZWNvbmRNb250aCldO1xuICAgIHJldHVybiBhLnllYXIgPT09IGIueWVhciAmJiBhLm1vbnRoID09PSBiLm1vbnRoO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNOZXh0TW9udGgodGFyZ2V0OiBEYXlQYXJhbWV0ZXIsIG9yaWdpbjogRGF5UGFyYW1ldGVyKSB7XG4gICAgY29uc3QgW2EsIGJdID0gW3RvQ2FsZW5kYXJEYXkodGFyZ2V0KSwgdG9DYWxlbmRhckRheShvcmlnaW4pXTtcbiAgICByZXR1cm4gYS55ZWFyID09PSBiLnllYXIgPyBhLm1vbnRoID4gYi5tb250aCA6IGEueWVhciA+IGIueWVhcjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzUHJldmlvdXNNb250aCh0YXJnZXQ6IERheVBhcmFtZXRlciwgb3JpZ2luOiBEYXlQYXJhbWV0ZXIpIHtcbiAgICBjb25zdCBbYSwgYl0gPSBbdG9DYWxlbmRhckRheSh0YXJnZXQpLCB0b0NhbGVuZGFyRGF5KG9yaWdpbildO1xuICAgIHJldHVybiBhLnllYXIgPT09IGIueWVhciA/IGEubW9udGggPCBiLm1vbnRoIDogYS55ZWFyIDwgYi55ZWFyO1xufVxuXG4vKiogUmV0dXJucyB0aGUgbmV4dCBkYXRlIHN0YXJ0aW5nIGZyb20gYHN0YXJ0YCB0aGF0IGRvZXMgbm90IG1hdGNoIHRoZSBgZGlzYWJsZWRgIGRlc2NyaXB0b3JzICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmV4dEFjdGl2ZURhdGUoXG4gICAgc3RhcnQ6IENhbGVuZGFyRGF5LFxuICAgIGRpc2FibGVkOiBEYXRlUmFuZ2VEZXNjcmlwdG9yW10gPSBbXSxcbikge1xuICAgIHdoaWxlIChpc0RhdGVJblJhbmdlcyhzdGFydCwgZGlzYWJsZWQpKSB7XG4gICAgICAgIHN0YXJ0ID0gc3RhcnQuYWRkKFwiZGF5XCIsIDEpO1xuICAgIH1cblxuICAgIHJldHVybiBzdGFydDtcbn1cblxuLyoqIFJldHVybnMgdGhlIHByZXZpb3VzIGRhdGUgc3RhcnRpbmcgZnJvbSBgc3RhcnRgIHRoYXQgZG9lcyBub3QgbWF0Y2ggdGhlIGBkaXNhYmxlZGAgZGVzY3JpcHRvcnMgKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRQcmV2aW91c0FjdGl2ZURhdGUoXG4gICAgc3RhcnQ6IENhbGVuZGFyRGF5LFxuICAgIGRpc2FibGVkOiBEYXRlUmFuZ2VEZXNjcmlwdG9yW10gPSBbXSxcbikge1xuICAgIHdoaWxlIChpc0RhdGVJblJhbmdlcyhzdGFydCwgZGlzYWJsZWQpKSB7XG4gICAgICAgIHN0YXJ0ID0gc3RhcnQuYWRkKFwiZGF5XCIsIC0xKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhcnQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDbG9zZXN0QWN0aXZlRGF0ZShcbiAgICBzdGFydDogQ2FsZW5kYXJEYXksXG4gICAgZGVsdGE6IG51bWJlcixcbiAgICBkaXNhYmxlZDogRGF0ZVJhbmdlRGVzY3JpcHRvcltdID0gW10sXG4pOiBDYWxlbmRhckRheSB7XG4gICAgLy8gVE9ETzogaW1wbGVtZW50IGEgbW9yZSByb2J1c3QgbG9naWMgZm9yIG1heCBhdHRlbXB0cyxcbiAgICAvLyBpLmUuIHRoZSBhbW91bnQgb2YgZGF5cyB0byBqdW1wIGJldHdlZW4gYmVmb3JlIGdpdmluZyB1cFxuICAgIC8vIGN1cnJlbnRseSBpdCB3aWxsIHRyeSB0byBmaW5kIHRoZSBjbG9zZXN0IGRhdGUgZm9yIGEgeWVhclxuICAgIGNvbnN0IG1heEF0dGVtcHRzID0gMzY2O1xuICAgIGxldCBkYXRlID0gc3RhcnQ7XG4gICAgbGV0IGF0dGVtcHRzID0gMDtcblxuICAgIHdoaWxlIChhdHRlbXB0cyA8IG1heEF0dGVtcHRzKSB7XG4gICAgICAgIGRhdGUgPSBzdGFydC5hZGQoXCJkYXlcIiwgZGVsdGEgKiAoYXR0ZW1wdHMgKyAxKSk7XG5cbiAgICAgICAgaWYgKCFpc0RhdGVJblJhbmdlcyhkYXRlLCBkaXNhYmxlZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBkYXRlO1xuICAgICAgICB9XG5cbiAgICAgICAgYXR0ZW1wdHMrKztcbiAgICB9XG5cbiAgICByZXR1cm4gZGF0ZTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIGEgZ2VuZXJhdG9yIHlpZWxkaW5nIGRheSB2YWx1ZXMgYmV0d2VlbiBgc3RhcnRgIGFuZCBgZW5kYCAobm9uLWluY2x1c2l2ZSlcbiAqIGJ5IGEgZ2l2ZW4gYHVuaXRgIGFzIGEgc3RlcC5cbiAqXG4gKiBAcmVtYXJrc1xuICogQnkgZGVmYXVsdCwgYHVuaXRgIGlzIHNldCB0byAnZGF5Jy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uKiBjYWxlbmRhclJhbmdlKG9wdGlvbnM6IENhbGVuZGFyUmFuZ2VQYXJhbXMpIHtcbiAgICBsZXQgbG93ID0gdG9DYWxlbmRhckRheShvcHRpb25zLnN0YXJ0KTtcbiAgICBjb25zdCB1bml0ID0gb3B0aW9ucy51bml0ID8/IFwiZGF5XCI7XG4gICAgY29uc3QgaGlnaCA9XG4gICAgICAgIHR5cGVvZiBvcHRpb25zLmVuZCA9PT0gXCJudW1iZXJcIlxuICAgICAgICAgICAgPyBsb3cuYWRkKHVuaXQsIG9wdGlvbnMuZW5kKVxuICAgICAgICAgICAgOiB0b0NhbGVuZGFyRGF5KG9wdGlvbnMuZW5kKTtcblxuICAgIGNvbnN0IHJldmVyc2UgPSBoaWdoLmxlc3NUaGFuKGxvdyk7XG4gICAgY29uc3Qgc3RlcCA9IHJldmVyc2UgPyAtMSA6IDE7XG5cbiAgICB3aGlsZSAoIXJldmVyc2UgPyBsb3cubGVzc1RoYW4oaGlnaCkgOiBsb3cuZ3JlYXRlclRoYW4oaGlnaCkpIHtcbiAgICAgICAgeWllbGQgbG93O1xuICAgICAgICBsb3cgPSBsb3cuYWRkKHVuaXQsIHN0ZXApO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uKiBnZW5lcmF0ZU1vbnRoKHZhbHVlOiBEYXlQYXJhbWV0ZXIsIGZpcnN0V2Vla0RheTogbnVtYmVyKSB7XG4gICAgY29uc3QgeyB5ZWFyLCBtb250aCB9ID0gdG9DYWxlbmRhckRheSh2YWx1ZSk7XG5cbiAgICBjb25zdCBzdGFydCA9IG5ldyBDYWxlbmRhckRheSh7IHllYXIsIG1vbnRoIH0pO1xuICAgIGNvbnN0IG9mZnNldCA9IG1vZHVsbyhzdGFydC5kYXkgLSBmaXJzdFdlZWtEYXksIGRheXNJbldlZWspO1xuICAgIHlpZWxkKiBjYWxlbmRhclJhbmdlKHtcbiAgICAgICAgc3RhcnQ6IHN0YXJ0LmFkZChcImRheVwiLCAtb2Zmc2V0KSxcbiAgICAgICAgZW5kOiA0MixcbiAgICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFllYXJSYW5nZShjdXJyZW50OiBEYXlQYXJhbWV0ZXIsIHJhbmdlOiBudW1iZXIpIHtcbiAgICBjb25zdCB5ZWFyID0gdG9DYWxlbmRhckRheShjdXJyZW50KS55ZWFyO1xuICAgIGNvbnN0IHN0YXJ0ID0gTWF0aC5mbG9vcih5ZWFyIC8gcmFuZ2UpICogcmFuZ2U7XG4gICAgcmV0dXJuIHsgc3RhcnQsIGVuZDogc3RhcnQgKyByYW5nZSAtIDEgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRGF0ZUluUmFuZ2VzKFxuICAgIGRhdGU6IERheVBhcmFtZXRlcixcbiAgICByYW5nZXM6IERhdGVSYW5nZURlc2NyaXB0b3JbXSxcbikge1xuICAgIGNvbnN0IHZhbHVlID0gdG9DYWxlbmRhckRheShkYXRlKTtcblxuICAgIHJldHVybiByYW5nZXMuc29tZSgocmFuZ2UpID0+IHtcbiAgICAgICAgY29uc3QgZGF5cyA9IChyYW5nZS5kYXRlUmFuZ2UgPz8gW10pLm1hcCgoZGF5KSA9PiB0b0NhbGVuZGFyRGF5KGRheSkpO1xuXG4gICAgICAgIHN3aXRjaCAocmFuZ2UudHlwZSkge1xuICAgICAgICAgICAgY2FzZSBEYXRlUmFuZ2VUeXBlLkFmdGVyOlxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS5ncmVhdGVyVGhhbihmaXJzdChkYXlzKSk7XG5cbiAgICAgICAgICAgIGNhc2UgRGF0ZVJhbmdlVHlwZS5CZWZvcmU6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLmxlc3NUaGFuKGZpcnN0KGRheXMpKTtcblxuICAgICAgICAgICAgY2FzZSBEYXRlUmFuZ2VUeXBlLkJldHdlZW46IHtcbiAgICAgICAgICAgICAgICBjb25zdCBtaW4gPSBNYXRoLm1pbihcbiAgICAgICAgICAgICAgICAgICAgZmlyc3QoZGF5cykudGltZXN0YW1wLFxuICAgICAgICAgICAgICAgICAgICBsYXN0KGRheXMpLnRpbWVzdGFtcCxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1heCA9IE1hdGgubWF4KFxuICAgICAgICAgICAgICAgICAgICBmaXJzdChkYXlzKS50aW1lc3RhbXAsXG4gICAgICAgICAgICAgICAgICAgIGxhc3QoZGF5cykudGltZXN0YW1wLFxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLnRpbWVzdGFtcCA+PSBtaW4gJiYgdmFsdWUudGltZXN0YW1wIDw9IG1heDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FzZSBEYXRlUmFuZ2VUeXBlLlNwZWNpZmljOlxuICAgICAgICAgICAgICAgIHJldHVybiBkYXlzLnNvbWUoKGRheSkgPT4gZGF5LmVxdWFsVG8odmFsdWUpKTtcblxuICAgICAgICAgICAgY2FzZSBEYXRlUmFuZ2VUeXBlLldlZWtkYXlzOlxuICAgICAgICAgICAgICAgIHJldHVybiAhdmFsdWUud2Vla2VuZDtcblxuICAgICAgICAgICAgY2FzZSBEYXRlUmFuZ2VUeXBlLldlZWtlbmRzOlxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS53ZWVrZW5kO1xuXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9ybWF0VG9QYXJ0cyhcbiAgICBkYXRlOiBEYXRlLFxuICAgIGxvY2FsZTogc3RyaW5nLFxuICAgIG9wdGlvbnM6IEludGwuRGF0ZVRpbWVGb3JtYXRPcHRpb25zLFxuICAgIHBhcnRzOiBzdHJpbmdbXSxcbik6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGNvbnN0IGZvcm1hdHRlciA9IG5ldyBJbnRsLkRhdGVUaW1lRm9ybWF0KGxvY2FsZSwgb3B0aW9ucyk7XG4gICAgY29uc3QgcmVzdWx0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICAgICBkYXRlLFxuICAgICAgICBmdWxsOiBmb3JtYXR0ZXIuZm9ybWF0KGRhdGUpLFxuICAgIH07XG5cbiAgICBjb25zdCBnZXRGb3JtYXR0ZWRQYXJ0ID0gKFxuICAgICAgICBmb3JtYXR0ZWRQYXJ0czogSW50bC5EYXRlVGltZUZvcm1hdFBhcnRbXSxcbiAgICAgICAgcGFydFR5cGU6IHN0cmluZyxcbiAgICApOiBJRm9ybWF0dGVkUGFydHMgPT4ge1xuICAgICAgICBjb25zdCBwYXJ0ID0gZm9ybWF0dGVkUGFydHMuZmluZCgoeyB0eXBlIH0pID0+IHR5cGUgPT09IHBhcnRUeXBlKTtcbiAgICAgICAgY29uc3QgbmV4dFBhcnQgPSBmb3JtYXR0ZWRQYXJ0c1tmb3JtYXR0ZWRQYXJ0cy5pbmRleE9mKHBhcnQpICsgMV07XG4gICAgICAgIGNvbnN0IHZhbHVlID0gcGFydD8udmFsdWUgfHwgXCJcIjtcbiAgICAgICAgY29uc3QgbGl0ZXJhbCA9IG5leHRQYXJ0Py50eXBlID09PSBcImxpdGVyYWxcIiA/IG5leHRQYXJ0LnZhbHVlIDogXCJcIjtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgbGl0ZXJhbCxcbiAgICAgICAgICAgIGNvbWJpbmVkOiB2YWx1ZSArIGxpdGVyYWwsXG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIGlmIChcImZvcm1hdFRvUGFydHNcIiBpbiBmb3JtYXR0ZXIpIHtcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkUGFydHMgPSBmb3JtYXR0ZXIuZm9ybWF0VG9QYXJ0cyhkYXRlKTtcbiAgICAgICAgcGFydHMuZm9yRWFjaChcbiAgICAgICAgICAgIChwYXJ0KSA9PiAocmVzdWx0W3BhcnRdID0gZ2V0Rm9ybWF0dGVkUGFydChmb3JtYXR0ZWRQYXJ0cywgcGFydCkpLFxuICAgICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHBhcnRzLmZvckVhY2goXG4gICAgICAgICAgICAocGFydCkgPT4gKHJlc3VsdFtwYXJ0XSA9IHsgdmFsdWU6IFwiXCIsIGxpdGVyYWw6IFwiXCIsIGNvbWJpbmVkOiBcIlwiIH0pLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQ7XG59XG4iXX0=